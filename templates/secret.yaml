apiVersion: v1
kind: Secret
metadata:
  name: {{ include "ctfd.fullname" . }}
type: Opaque
data:
  {{- OLD_SECRET := lookup "v1" "Secret" .Release.Namespace (include "ctfd.fullname" .) -}}
  {{- if or (not $OLD_SECRET) (not $OLD_SECRET.data.SECRET_KEY) }}
  SECRET_KEY: {{ randAlphaNum 20 | b64enc }}
  {{ else }}
  SECRET_KEY: {{ $OLD_SECRET.data.SECRET_KEY }}
  {{ end }}
  DATABASE_URL: {{ include "ctfd.DATABASE_URL" . | b64enc }}
  REDIS_URL: {{ include "ctfd.REDIS_URL" . | b64enc }}
  {{- if .Values.ctfd.uploadprovider.s3.enabled }}
  AWS_ACCESS_KEY_ID: {{ .Values.ctfd.uploadprovider.s3.access_key_id | b64enc }}
  AWS_SECRET_ACCESS_KEY: {{ .Values.ctfd.uploadprovider.s3.secret_access_key | b64enc }}
  AWS_S3_BUCKET: {{ .Values.ctfd.uploadprovider.s3.bucket | b64enc }}
  AWS_S3_ENDPOINT_URL: {{ .Values.ctfd.uploadprovider.s3.endpoint_url | b64enc }}
  {{- end }}
